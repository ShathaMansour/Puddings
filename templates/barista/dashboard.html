{% extends "index.html" %}
{% block title %}Barista Dashboard{% endblock %}

{% block content %}

<h1 class="barista-title">Barista Dashboard</h1>

<div class="barista-datetime">
    <span id="barista-date"></span>
    <span id="barista-time"></span>
</div>

<div class="barista-columns">

    <!-- PENDING -->
    <div class="barista-column" id="pending" ondrop="drop(event)" ondragover="allowDrop(event)">
        <h2>Pending</h2>
        {% for o in orders if o.status == "pending" %}
            {% include 'barista/order_card.html' %}
        {% endfor %}
    </div>

    <!-- IN PROGRESS -->
    <div class="barista-column" id="progress" ondrop="drop(event)" ondragover="allowDrop(event)">
        <h2>In Progress</h2>
        {% for o in orders if o.status == "progress" %}
            {% include 'barista/order_card.html' %}
        {% endfor %}
    </div>

    <!-- READY -->
    <div class="barista-column" id="ready" ondrop="drop(event)" ondragover="allowDrop(event)">
        <h2>Ready</h2>
        {% for o in orders if o.status == "ready" %}
            {% include 'barista/order_card.html' %}
        {% endfor %}
    </div>

        <!-- COLLECTED -->
    <div class="barista-column" id="collected" ondrop="drop(event)" ondragover="allowDrop(event)">
    <h2>Collected</h2>
        {% for o in orders if o.status == "collected" %}
            {% include 'barista/order_card.html' %}
        {% endfor %}
    </div>

</div>

<a class="logout-btn" href="/logout">Logout</a>

<script>
// Allow dropping
function allowDrop(ev) {
    ev.preventDefault();
}

// Start 3-minute fade-out timer
function startCollectedTimer(card) {
    if (card.dataset.timerStarted === "true") return;
    card.dataset.timerStarted = "true";

    setTimeout(() => {
        card.style.transition = "opacity 1s ease";
        card.style.opacity = "0";

        setTimeout(() => card.remove(), 1000);
    }, 3000);
}

// Drag start
function drag(ev) {
    ev.dataTransfer.setData("order_id", ev.target.dataset.id);
}

// Drop handler
function drop(ev) {
    ev.preventDefault();

    const column = ev.target.closest(".barista-column");
    if (!column) return;

    const orderId = ev.dataTransfer.getData("order_id");
    const card = document.querySelector(`[data-id='${orderId}']`);

    // Move card visually
    column.appendChild(card);

    // If dropped in "collected" column -> start countdown
    if (column.id === "collected") {
        startCollectedTimer(card);
    }

    // Update backend
    fetch("/barista/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            order_id: orderId,
            status: column.id
        })
    });
}

// Clock updater
function updateBaristaClock() {
    const dateEl = document.getElementById("barista-date");
    const timeEl = document.getElementById("barista-time");

    const now = new Date();
    const dateOpt = { weekday: "long", year: "numeric", month: "long", day: "numeric" };

    dateEl.textContent = now.toLocaleDateString("en-UK", dateOpt);
    timeEl.textContent = now.toLocaleTimeString("en-UK", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
    });
}

// Start clock
updateBaristaClock();
setInterval(updateBaristaClock, 1000);

// Start timers for orders already in collected
document.querySelectorAll("#collected .order-card").forEach(startCollectedTimer);
</script>


{% endblock %}
